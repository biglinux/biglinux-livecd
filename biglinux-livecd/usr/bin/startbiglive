#!/bin/bash
#===============================================================================
# Script Name: startbiglive
# Description: Live session bootstrap for BigLinux
#              Initializes display manager, configures monitors, and launches
#              the live setup wizard before starting the desktop session.
# Package:     biglinux-livecd
#
# Dependencies:
#   - systemctl (display manager detection)
#   - xrandr (X11 multi-monitor configuration)
#   - python3 (live setup wizard)
#   - kwin_wayland, mutter (Wayland compositors)
#===============================================================================

#-------------------------------------------------------------------------------
# Detect active display manager
#-------------------------------------------------------------------------------
for dm in sddm gdm lightdm lxdm; do
    if systemctl status "$dm" &>/dev/null; then
        display_manager="$dm"
        break
    fi
done
display_manager="${display_manager:-unknown}"

#-------------------------------------------------------------------------------
# X11: Configure multi-monitor mirroring
# Duplicates all connected monitors to show the same content
#-------------------------------------------------------------------------------
if [[ "$XDG_SESSION_TYPE" == "x11" ]]; then
    monitors=$(xrandr | grep -w connected | awk '{print $1}')
    first_monitor=$(echo "$monitors" | awk '{print $1}')
    resolution_first_monitor=$(xrandr | grep "$first_monitor connected" -A1 | tail -n1 | awk '{print $1}')

    xrandr_configuration=""
    for monitor in $monitors; do
        if [[ "$monitor" != "$first_monitor" ]]; then
            xrandr_configuration="$xrandr_configuration --output $monitor --same-as $first_monitor --mode $resolution_first_monitor"
        fi
    done

    # Apply mirroring configuration
    xrandr $xrandr_configuration
fi

#-------------------------------------------------------------------------------
# SDDM: Disable screen lock and kwallet for live session
#-------------------------------------------------------------------------------
if [[ "$display_manager" == "sddm" ]]; then
    if ! grep -q 'Autolock=false' ~/.config/kscreenlockerrc 2>/dev/null; then
        sed -i '/\[Daemon\]/a\'$'\n''Autolock=false\nLockOnResume=false' ~/.config/kscreenlockerrc
    fi
fi

# Disable kwallet to prevent password prompts during live session
if ! grep -q 'Enabled=false' ~/.config/kwalletrc 2>/dev/null; then
    echo '[Wallet]
Enabled=false' >> ~/.config/kwalletrc
fi

#-------------------------------------------------------------------------------
# Check for custom boot command via kernel cmdline (biglinux.bootcmd=)
# This allows booting directly into specific modes like only-calamares
#-------------------------------------------------------------------------------
eval "kernel_args=( $(</proc/cmdline) )"
for arg in "${kernel_args[@]}"; do
    case "$arg" in
        biglinux.bootcmd=*)
            ${arg#biglinux.bootcmd=}
            exit
            ;;
    esac
done

# Apply Qt/GTK theme sync if available
if [[ -e /usr/share/sync-kde-and-gtk-places/sync-gnome-theme-to-qt.sh ]]; then
    /usr/share/sync-kde-and-gtk-places/sync-gnome-theme-to-qt.sh
fi

#-------------------------------------------------------------------------------
# Launch live setup wizard
# Different launch methods depending on session type and display manager
#-------------------------------------------------------------------------------
if [[ "$XDG_SESSION_TYPE" == "x11" ]]; then
    systemctl --user start plasma-kglobalaccel.service
    python /usr/share/biglinux/livecd/main.py
else
    # Wayland session: launch appropriate compositor with setup wizard
    if [[ "$display_manager" == "sddm" ]]; then
        export DESKTOP_SESSION=KDE
        export XDG_SESSION_DESKTOP=KDE
        export QT_QPA_PLATFORMTHEME=kvantum
        export GDMSESSION=KDE
        export XDG_CURRENT_DESKTOP=KDE
        export QT_SCALE_FACTOR_ROUNDING_POLICY=RoundPreferFloor
        systemctl --user start plasma-kglobalaccel.service
        dbus-run-session kwin_wayland --drm --no-lockscreen --xwayland 'python /usr/share/biglinux/livecd/main.py'
    elif [[ "$display_manager" == "gdm" ]]; then
        export DESKTOP_SESSION=gnome
        export XDG_SESSION_DESKTOP=gnome
        export GDMSESSION=gnome
        export XDG_CURRENT_DESKTOP=gnome
        export QT_SCALE_FACTOR_ROUNDING_POLICY=RoundPreferFloor
        gsettings set org.gnome.desktop.interface icon-theme bigicons-papient
        gsettings set org.gnome.desktop.interface cursor-theme Bibata-Modern-Classic
        mutter --wayland /usr/bin/gnome-bbv-live-session
    fi
fi

wait

#-------------------------------------------------------------------------------
# Apply language and locale settings from user selection
#-------------------------------------------------------------------------------
if [[ -f /tmp/big_language ]]; then
    export LANGUAGE=$(</tmp/big_language).UTF-8
    export LANG=$(</tmp/big_language).UTF-8
    export LC_MESSAGES=$(</tmp/big_language).UTF-8
    export LC_ALL=$(</tmp/big_language).UTF-8
    echo "$(</tmp/big_language)" > "$HOME/.config/user-dirs.locale"
    echo -e "[Formats]\nLANG=$(</tmp/big_language).UTF-8" > "$HOME/.config/plasma-localerc"
fi

#-------------------------------------------------------------------------------
# Create user directories and installer shortcut on desktop
#-------------------------------------------------------------------------------
xdg-user-dirs-update
. ~/.config/user-dirs.dirs
cp -f "/usr/share/applications/com.biglinux.calamares-config.desktop" "$XDG_DESKTOP_DIR/calamares-biglinux.desktop"
chmod +x "$XDG_DESKTOP_DIR/calamares-biglinux.desktop"

cd ~

#-------------------------------------------------------------------------------
# Wait for user manager and D-Bus session bus to be ready
# This prevents cinnamon-session/gnome-session from crashing due to missing D-Bus
#-------------------------------------------------------------------------------
_wait_for_user_session() {
    local max_wait=60
    local count=0
    while [[ $count -lt $max_wait ]]; do
        if systemctl --user is-active default.target &>/dev/null 2>&1; then
            break
        fi
        sleep 1
        ((count++))
    done
    if [[ $count -ge $max_wait ]]; then
        logger "startbiglive: WARNING - user session not ready after ${max_wait}s, proceeding anyway"
    fi
}

_wait_for_user_session

# Fix to KDE Plasma using en_US
rm ~/.cache/ksycoca*

#-------------------------------------------------------------------------------
# Start appropriate desktop session based on detected environment
# Using exec to prevent fallthrough to systemctl restart
#-------------------------------------------------------------------------------

# BigCommunity Core: Launch Calamares directly
if grep -iq 'BigCommunity-Core.iso' /proc/cmdline; then
    exec sudo calamares_polkit

elif [[ "$display_manager" == "gdm" ]]; then
    # GNOME: Clean up and start gnome-session
    rm -f "$HOME/Empty Bash" "$HOME/Empty Desktop File.desktop" "$HOME/Empty File"
    xdg-user-dirs-update
    exec startgnome-community

elif [[ -e /usr/share/wayland-sessions/hyprland.desktop ]]; then
    # Hyprland detected
    exec Hyprland

elif [[ "$display_manager" == "sddm" || "$display_manager" == "lxdm" ]]; then
    # KDE Plasma
    if [[ "$XDG_SESSION_TYPE" == "x11" ]]; then
        exec startkde-biglinux
    else
        exec startkde-biglinux wayland
    fi

elif [[ -e /usr/share/xsessions/xfce.desktop ]]; then
    # XFCE
    export XDG_MENU_PREFIX=xfce-
    export DESKTOP_SESSION=xfce
    export XDG_SESSION_DESKTOP=xfce
    export GDMSESSION=xfce
    export XDG_CURRENT_DESKTOP=XFCE
    exec startxfce4

elif [[ -e /usr/bin/startcinnamon-community ]]; then
    # Cinnamon: Clean up and start cinnamon-session
    rm -f "$HOME/Empty Bash" "$HOME/Empty Desktop File.desktop" "$HOME/Empty File"
    xdg-user-dirs-update
    exec startcinnamon-community
fi

# Fallback: restart display manager only if no session starter was found
sudo systemctl restart "$display_manager"
